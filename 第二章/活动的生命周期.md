# æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸ

æ·±å…¥äº†è§£æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸå¯¹äºæˆ‘ä»¬å†™å‡ºæµç•…çš„ç¨‹åºæ˜¯å¾ˆæœ‰å¸®åŠ©, å› ä¸ºæ¯ä¸ªç”Ÿå‘½å‘¨æœŸçš„ hook æ–¹æ³•, å¯ä»¥åœ¨æ´»åŠ¨ä¸åŒçŠ¶æ€çš„æ—¶å€™ä¼šè¢«è°ƒç”¨.
åœ¨äº†è§£ç”Ÿå‘½å‘¨æœŸæ—¶ï¼Œæˆ‘ä»¬å…ˆæ¥äº†è§£å‡ ä¸ªæ¦‚å¿µ.

## è¿”å›æ ˆ

é€šè¿‡å‰é¢ä¾‹å­ä½¿ç”¨, å¯ä»¥å‘ç°ä¸€ä¸ªç‚¹, Android ä¸­çš„æ´»åŠ¨æ˜¯å¯ä»¥å±‚å çš„. æˆ‘ä»¬æ¯å¯åŠ¨ä¸€ä¸ªæ–°çš„æ´»åŠ¨, å°±ä¼šè¦†ç›–åœ¨åŸæ¥æ´»åŠ¨æ™ºå•†ï¼Œç„¶åç‚¹å‡» Back é”®ä¼šé”€æ¯æœ€ä¸Šé¢çš„æ´»åŠ¨,ä¸‹é¢çš„æ´»åŠ¨å°±ä¼šé‡æ–°æ˜¾ç¤ºå‡ºæ¥.

Android æœ¬è´¨æ˜¯é€šè¿‡ä»»åŠ¡ï¼ˆTaskï¼‰æ¥ç®¡ç†æ´»åŠ¨çš„ï¼Œ ä¸€ä¸ªä»»åŠ¡å°±æ˜¯ä¸€ç»„å­˜æ”¾åœ¨æ ˆé‡Œçš„æ´»åŠ¨çš„é›†åˆ, è¿™ä¸ªæ ˆä¹Ÿè¢«ç§°ä½œ**è¿”å›æ ˆ(Back Stack)**.

é‚£ä¹ˆè¿™é‡Œåˆå¼•å…¥â€œæ ˆâ€æ¦‚å¿µ, ä¸»è¦ç‰¹æ€§å³å¯

> åè¿›å…ˆå‡º æˆ– å…ˆè¿›åå‡º

é»˜è®¤æƒ…å†µä¸‹, æ¯å½“å¯åŠ¨ä¸€ä¸ªæ–°çš„æ´»åŠ¨, å®ƒä¼šåœ¨è¿”å›æ ˆä¸­å…¥æ ˆï¼Œå¹¶å¤„äºæ ˆé¡¶çš„ä½ç½®. è€Œæ¯å½“æˆ‘ä»¬æŒ‰ä¸‹ ``Back`` é”®æˆ–è°ƒç”¨ ``finish()`` æ–¹æ³•å»é”€æ¯ä¸€ä¸ªæ—¶ï¼Œå¤„äºæ ˆé¡¶çš„æ´»åŠ¨ä¼šå‡ºæ ˆ,è¿™æ—¶å‰ä¸€ä¸ªå…¥æ ˆçš„æ´»åŠ¨å°±ä¼šé‡ç°å¤„äºæ ˆé¡¶çš„ä½ç½®. ç³»ç»Ÿæ€»æ˜¯æ˜¾ç¤ºå¤„äºæ ˆç‚¹çš„æ´»åŠ¨ç»™ç”¨æˆ·.

å¤§æ¦‚æµç¨‹å¦‚ä¸‹å›¾ï¼Œæ‰€ç¤º:

![avatar](img/Android_studio_activity_stack.png)


## æ´»åŠ¨çŠ¶æ€

æ¯ä¸ªæ´»åŠ¨åœ¨å…¶ç”Ÿå‘½å‘¨æœŸä¸­æœ€å¤šå¯èƒ½ä¼šæœ‰4ä¸­çŠ¶æ€.

* è¿è¡ŒçŠ¶æ€

> å½“ä¸€ä¸ªæ´»åŠ¨ä½äºè¿”å›æ ˆçš„æ ˆé¡¶æ—¶ï¼Œè¿™æ—¶æ´»åŠ¨å°±å¤„äºè¿è¡ŒçŠ¶æ€. ç³»ç»Ÿæœ€ä¸æ„¿æ„å»å›æ”¶è¿™ç§æ´»åŠ¨ï¼Œå› ä¸ºè¿™æ ·å°±ä¼šé€ æˆä½“éªŒå¾ˆå·®.

* æš‚åœçŠ¶æ€

> å½“ä¸€ä¸ªæ´»åŠ¨ä¸å¤„äºæ ˆç‚¹, ä½†ä»»ç„¶å¯è§ï¼Œè¿™æ—¶æ´»åŠ¨å°±è¿›å…¥äº†æš‚åœçŠ¶æ€.  è¿™æ˜¯å› ä¸ºæ¯ä¸ªæ´»åŠ¨ä¸ä¸€å®šé“ºæ»¡æ•´ä¸ªå±å¹•, æ¯”å¦‚ å¯¹è¯æ¡†å½¢å¼çš„æ´»åŠ¨åªä¼šå ç”¨å±å¹•ä¸­é—´çš„éƒ¨åˆ†åŒºåŸŸ.  å¤„äºæš‚åœçŠ¶æ€çš„æ´»åŠ¨æ˜¯å­˜æ´»çš„ï¼Œç³»ç»ŸåŒæ ·ä¹Ÿä¸æ„¿æ„å»å›æ”¶.

* åœæ­¢çŠ¶æ€
> å½“ä¸€ä¸ªæ´»åŠ¨ä¸å¤„äºæ ˆé¡¶ï¼Œå¹¶å®Œå…¨ä¸å¯è§æ—¶ ğŸ™…â€â™‚ï¸, è¿™æ—¶æ´»åŠ¨å°±è¿›å…¥åœæ­¢çŠ¶æ€. ç³»ç»Ÿä»»ç„¶ä¼šä¸ºè¿™ç§æ´»åŠ¨ä¿å­˜ç›¸åº”çš„çŠ¶æ€å’Œæˆå‘˜å˜é‡ï¼Œä½†æ˜¯è¿™å¹¶ä¸å®Œå…¨å¯é çš„, å½“å…¶å®ƒåœ°æ–¹éœ€è¦å†…å­˜æ—¶ï¼Œå¤„äºåœæ­¢çŠ¶æ€çš„æ´»åŠ¨æœ‰å¯èƒ½è¢«ç³»ç»Ÿå›æ”¶.

* é”€æ¯çŠ¶æ€

> å½“ä¸€ä¸ªæ´»åŠ¨ä»è¿”å›æ ˆä¸­ç§»é™¤åå°±å˜æˆäº†é”€æ¯çŠ¶æ€. ç³»ç»Ÿä¼šæœ€å€¾å‘äºå›æ”¶å¤„äºè¿™ç§çŠ¶æ€çš„æ´»åŠ¨, ä»è€Œä¿è¯æ‰‹æœºçš„å†…å­˜è¶³å¤Ÿ.

## æ´»åŠ¨çš„ç”Ÿå­˜æœŸ

Activity ç±»ä¸­å®šä¹‰äº† 7 ä¸ªå›è°ƒæ–¹æ³•ï¼Œè¦†ç›–äº†æ´»åŠ¨ç”Ÿå‘½å‘¨æœŸçš„æ¯ä¸€ä¸ªç¯èŠ‚ï¼ŒğŸ‘‡å°±æ¥ä¸€ä¸€äº†è§£.

* onCreate() åˆ›å»º
> æ¯ä¸ªæ´»åŠ¨ä¸­æˆ‘ä»¬éƒ½é‡å†™äº†è¿™ä¸ªæ–¹æ³•ï¼Œå®ƒä¼šåœ¨æ´»åŠ¨ç¬¬ä¸€æ¬¡åˆ›å»ºçš„æ—¶å€™è°ƒç”¨. ä¸€èˆ¬åœ¨è¿™ä¸ªæ–¹æ³•ä¸­å®Œæˆæ´»åŠ¨çš„åˆå§‹åŒ–æ“ä½œï¼Œæ¯”å¦‚ åŠ è½½å¸ƒå±€ï¼Œç»‘å®šäº‹ä»¶ç­‰.
* onStart() å¯åŠ¨
> è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨ç”±ä¸å¯è§å˜ä¸ºå¯è§çš„æ—¶å€™è°ƒç”¨.
* onResume() æ¢å¤
> è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨å‡†å¤‡å¥½å’Œç”¨æˆ·è¿›è¡Œäº¤äº’çš„æ—¶å€™è°ƒç”¨. æ­¤æ—¶æ´»åŠ¨ä¸€å®šä½äºè¿”å›æ ˆçš„æ ˆé¡¶,å¹¶å¤„äºæ´»åŠ¨çŠ¶æ€.
* onPause() æš‚åœ
> è¿™ä¸ªæ–¹æ³•åœ¨ç³»ç»Ÿå‡†å¤‡å»å¯åŠ¨æˆ–æ¢å¤å¦ä¸€ä¸ªæ´»åŠ¨çš„æ—¶å€™è°ƒç”¨. æˆ‘ä»¬é€šå¸¸ä¼šåœ¨è¿™ä¸ªæ–¹æ³•ä¸­å°†ä¸€äº›æ¶ˆè€—CPUçš„èµ„æºé‡Šæ”¾æ‰ï¼Œä»¥åŠä¿å­˜ä¸€äº›å…³é”®æ•°æ®ï¼Œä½†è¿™ä¸ªæ–¹æ³•çš„æ‰§è¡Œé€Ÿåº¦ä¸€å®šè¦å¿«ï¼Œä¸ç„¶ä¼šå½±å“åˆ°æ–°æ ˆé¡¶æ´»åŠ¨çš„ä½¿ç”¨ã€‚
* onStop() åœæ­¢
> è¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨å®Œå…¨ğŸ™…â€â™‚ï¸ä¸å¯è§çš„æ—¶å€™è°ƒç”¨ã€‚ å®ƒä¸ onPause()ä¸»è¦åŒºåˆ«åœ¨äºï¼Œå¦‚æœå¯åŠ¨çš„æ–°æ´»åŠ¨æ˜¯ä¸€ä¸ªå¯¹è¯æ¡†å¼çš„æ´»åŠ¨ï¼Œé‚£ä¹ˆ onPause()æ–¹æ³•ä¼šå¾—åˆ°æ‰§è¡Œï¼Œè€Œ onStop()æ–¹æ³•å¹¶ä¸ä¼šæ‰§è¡Œã€‚
* onDestroy() é”€æ¯
> è¿™ä¸ªæ–¹æ³•åœ¨ä¼šæ‡‚é”€æ¯å‰è°ƒç”¨ï¼Œä¹‹åæ´»åŠ¨å°±å˜æˆäº†é”€æ¯çŠ¶æ€
* onRestart() é‡å¯
> è¿™ä¸ªæ–¹æ³•æ˜¯åœ¨æ´»åŠ¨ç”±åœæ­¢çŠ¶æ€å˜æˆè¿è¡ŒçŠ¶æ€ä¹‹å‰è°ƒç”¨ï¼Œä¹Ÿå°±æ˜¯æ´»åŠ¨è¢«é‡æ–°å¯åŠ¨äº†ã€‚

ç»†å¿ƒè‚¯å®šå‘ç°è§„å¾‹ï¼Œé™¤äº† ``onRestart`` ä¹‹å¤–ï¼Œå…¶å®ƒéƒ½æ˜¯ä¸¤ä¸¤ç›¸å¯¹ï¼Œä»è€Œåˆå¯ä»¥åˆ†ä¸º3ä¸­ç”Ÿå­˜æœŸ

* å®Œæ•´ç”ŸæˆæœŸ

onCreate() -> onDestroy()

onCreate()è¿›è¡Œèµ„æºåŠ è½½ï¼Œåœ¨onDestroy()ä¸­è¿›è¡Œèµ„æºé‡Šæ”¾.

* å¯è§ç”Ÿå­˜æœŸ

onCreate() -> onStrp() æ–¹æ³•ä¹‹é—´æ‰€ç»å†çš„ï¼Œå°±æ˜¯å¯è§ç”Ÿå­˜æœŸ. åœ¨å¯è§ç”Ÿå­˜æœŸå†…ï¼Œæ´»åŠ¨å¯¹äºç”¨æˆ·æ€»æ˜¯å¯è§çš„ï¼Œå³ä¾¿æœ‰å¯èƒ½æ— æ³•ä¸ç”¨æˆ·è¿›è¡Œäº¤äº’ã€‚ æˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸¤ä¸ªæ–¹æ³•ï¼Œåˆç†çš„ç®¡ç†å“ªäº›å¯¹ç”¨æˆ·å¯è§çš„èµ„æºã€‚æ¯”å¦‚åœ¨ onCreate() ä¸­å¯¹èµ„æºè¿›è¡ŒåŠ è½½ï¼Œè€Œåœ¨ onStop() æ–¹æ³•ä¸­å¯¹èµ„æºè¿›è¡Œé‡Šæ”¾ï¼Œä»è€Œä¿è¯å¤„äºæš‚åœçŠ¶æ€çš„æ´»åŠ¨ä¸ä¼šæš‚ç”¨å¤ªå¤šçš„èµ„æº.

* å‰å°ç”Ÿå­˜æœŸ
onResume() -> onPause() æ´»åŠ¨åœ¨è¿™ä¸¤ä¸ªä¹‹é—´æ‰€ç»å†çš„å°±æ˜¯å‰å°ç”Ÿå­˜æœŸã€‚åœ¨å‰å°ç”Ÿå­˜æœŸå†…ï¼Œæ´»åŠ¨æ€»æ˜¯å¤„äºè¿è¡ŒçŠ¶æ€ï¼Œæ­¤æ—¶çš„æ´»åŠ¨æ˜¯å¯ä»¥å’Œç”¨æˆ·äº¤äº’çš„ï¼Œæˆ‘ä»¬å¹³çœ‹åˆ°å’Œæ¥è§¦æœ€å¤šçš„å°±æ˜¯è¿™ä¸ªçŠ¶æ€ä¸‹çš„æ´»åŠ¨.

ä¸ºäº†æ›´å¥½ç†è§£ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹ä¸‹é¢è¿™ä¸ªå›¾ï¼Œå®Œæ•´ç”Ÿå‘½å‘¨æœŸ:

![avatar](img/Activity_lifecycle.jpg)


## å®æˆ˜æ´»åŠ¨çš„ç”Ÿå‘½å‘¨æœŸ

è¿™é‡Œä¸»è¦å‡†å¤‡ä¸¤ä¸ªæ´»åŠ¨ï¼Œä¸€ä¸ªå¯¹è¯æ¡†å¼çš„æ´»åŠ¨ï¼ˆDialogActivityï¼‰ï¼Œä¸€ä¸ªæ˜¯æ­£å¸¸çš„æ´»åŠ¨(NormalActivity)

**MainActivity.java**

``` java

package com.example.activitylifecycletest;

import android.content.Intent;
import android.nfc.Tag;
import android.os.Bundle;

import com.google.android.material.floatingactionbutton.FloatingActionButton;
import com.google.android.material.snackbar.Snackbar;

import androidx.appcompat.app.AppCompatActivity;
import androidx.appcompat.widget.Toolbar;

import android.util.Log;
import android.view.View;
import android.view.Menu;
import android.view.MenuItem;
import android.widget.Button;

public class MainActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        Log.d("Life", "onCreate");
        setContentView(R.layout.activity_main);
        Button startNomarlActivity = (Button) findViewById(R.id.button_1);
        Button startDialogActivity = (Button) findViewById(R.id.button_2);

        startNomarlActivity.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(MainActivity.this, NormalActivity.class);
                startActivity(intent);
            }
        });
        startDialogActivity.setOnClickListener(new View.OnClickListener() {
            @Override
            public void onClick(View v) {
                Intent intent = new Intent(MainActivity.this, DialogActivity.class);
                startActivity(intent);
            }
        });
    }

    @Override
    protected void onStart() {
        super.onStart();
        Log.d("Life", "onStart");
        // The activity is about to become visible.
    }
    @Override
    protected void onResume() {
        super.onResume();
        // The activity has become visible (it is now "resumed").
        Log.d("Life", "onResume");
    }
    @Override
    protected void onPause() {
        super.onPause();
        // Another activity is taking focus (this activity is about to be "paused").
        Log.d("Life", "onPause");
    }
    @Override
    protected void onStop() {
        super.onStop();
        // The activity is no longer visible (it is now "stopped")
        Log.d("Life", "onStop");
    }
    @Override
    protected void onDestroy() {
        super.onDestroy();
        // The activity is about to be destroyed.
        Log.d("Life", "onDestroy");
    }

    @Override
    protected void onRestart() {
        super.onRestart();
        // The activity is about to be destroyed.
        Log.d("Life", "onRestart");
    }
}

```

**NormalActivity.java**

``` java

package com.example.activitylifecycletest;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;

public class NormalActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_normal);
    }
}

```

```xml

   <activity android:name=".NormalActivity"/>

```

**DialogActivity.java**

``` java

package com.example.activitylifecycletest;
import androidx.appcompat.app.AppCompatActivity;
import android.os.Bundle;

public class DialogActivity extends AppCompatActivity {

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);
        setContentView(R.layout.activity_dialog);
    }
}

```
é€šè¿‡æŒ‡å®š `` android:theme="@style/Theme.AppCompat.Dialog" ``,è¡¨ç¤ºå½“å‰æ´»åŠ¨æ˜¯å¯¹è¯æ¡†.

``` xml

  <activity android:name=".DialogActivity"  android:theme="@style/Theme.AppCompat.Dialog" ></activity>

```

ä»å‡ ä¸ªæ–¹é¢æ¥ä½“éªŒç”Ÿå‘½å‘¨æœŸ:

* å¯åŠ¨ MainActivity

onCreate()ã€onStart()ã€onResume()

* å¯åŠ¨ NormalActivity

onPause()ã€onStop()

* è¿”å› MainActivity

onRestart()ã€onStart()ã€onPause()

* å¯åŠ¨ DialogActivity

onPause()

* è¿”å› DialogActivity

onResume()

* é€€å‡ºåº”ç”¨ç¨‹åº

onPause()ã€onStop()ã€onDestroy()


## æ´»åŠ¨è¢«å›æ”¶äº†æ€ä¹ˆåŠ

å‰é¢çœ‹ç”Ÿå‘½å‘¨æœŸæ—¶æåŠï¼Œå½“ä¸€ä¸ªæ´»åŠ¨å¤„äºæš‚åœâ¸ï¸ï¼Œå½“ç³»ç»Ÿå†…å­˜ä¸è¶³çš„æƒ…å†µä¸‹æœ‰å¯èƒ½è¢«å›æ”¶ã€‚ é‚£ä¹ˆæƒ³è±¡ä¸€ä¸‹ä¸€ä¸ªå¸¸è§ï¼š

å¼•ç”¨ä¸­æœ‰ä¸€ä¸ªæ´»åŠ¨ A, ç”¨æˆ·åœ¨æ´»åŠ¨ A çš„åŸºç¡€ä¸Šå¯åŠ¨äº†æ´»åŠ¨ B, æ´»åŠ¨Aå°±è¿›å…¥äº†åœæ­¢çŠ¶æ€ï¼Œè¿™ä¸ªæ—¶å€™ç”±äºç³»ç»Ÿå†…å­˜ä¸è¶³ï¼Œå°†æ´»åŠ¨ Aå›æ”¶æ‰äº†ï¼Œ ç„¶åç”¨æˆ·æŒ‰ä¸‹ Back é”®è¿”å›æ´»åŠ¨ Aï¼Œä¼šå‡ºç°ä»€ä¹ˆæƒ…å†µï¼Ÿ

> è¿˜æ˜¯æ­£å¸¸æ˜¾ç¤ºæ´»åŠ¨ A çš„ï¼Œåªä¸è¿‡è¿™æ—¶å¹¶ä¸ä¼šæ‰§è¡Œ onRestart() æ–¹æ³•ï¼Œè€Œæ˜¯ä¼šæ‰§è¡Œæ´»åŠ¨ A çš„ onCreate() æ–¹æ³•ï¼Œå› ä¸ºæ´»åŠ¨ A åœ¨è¿™ç§æƒ…å†µä¸‹ä¼šè¢«é‡æ–°åˆ›å»ºä¸€æ¬¡.

å¦‚æœé‡åˆ°è¿™ç§æƒ…å†µï¼Œä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜å°±æ˜¯ A é¡µé¢çŠ¶æ€ä¸¢å¤±çš„é—®é¢˜ï¼Œé‚£ä¹ˆæ€ä¹ˆæ¥è§£å†³è¿™ä¸ªé—®é¢˜? åœ¨ Activity ä¸­æä¾›äº† ``onSaveInstanceState()`` ä¿æŠ¤å®ä¾‹çŠ¶æ€ï¼Œè¿™ä¸ªæ–¹æ³•åœ¨æ´»åŠ¨è¢«å›æ”¶æ—¶æ€»ä¼šè°ƒç”¨, onSaveInstanceState() æ–¹æ³•ç­¾åå¦‚ä¸‹ï¼š

``` java

    @Override
    protected void onCreate(Bundle savedInstanceState) {
        super.onCreate(savedInstanceState);

        Log.d("Life", "onCreate");
        setContentView(R.layout.activity_main);

        if(savedInstanceState != null){
            String tempDate = savedInstanceState.getString("data_key");
            Log.d("savedInstanceState", tempDate);
        }
        ...
    }

    @Override
    protected void onSaveInstanceState(Bundle outState) {
        super.onSaveInstanceState(outState);
        String tempData = "éœ€è¦ä¿å­˜çš„æ•°æ®";
        outState.putString("data_key", tempData);
    }

```









